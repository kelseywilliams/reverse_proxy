events {
    worker_connections 1024;
    multi_accept on;
    use epoll;
    accept_mutex on;
}

http {
    server {
        listen 80 default_server;
        server_name _;
        resolver 127.0.0.11;

        # API: /api/* -> http://api:3028/*
        location ^~ /api/ {
            proxy_pass http://api:3028/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Socket.IO: public /chat/socket.io/* -> upstream /socket.io/*
        location ^~ /chat/socket.io/ {
            proxy_pass http://chat:3029/socket.io/;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # IMPORTANT: if your Vite build outputs root-relative /assets/* URLs,
        # this routes those requests to the chat service instead of the home catch-all.
        location ^~ /assets/ {
            proxy_pass http://chat:3029;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Chat app at /chat/*
        location ^~ /chat/ {
            proxy_pass http://chat:3029;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Home app catch-all
        location / {
            rewrite ^/([^.?]+)$ /$1.html break;

            proxy_pass http://home:3027;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
